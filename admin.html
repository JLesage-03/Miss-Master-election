<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - NFONAP Elections 2025</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="assets/nfonap-logo.jpg">
    <style>
        /* Additional admin styles */
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .text-center { text-align: center; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 1rem; }
        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .ml-2 { margin-left: 0.5rem; }
        .btn-full { width: 100%; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .btn-lg { padding: 0.75rem 1.5rem; font-size: 1.125rem; }
        .form-control { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-text { font-size: 0.875rem; color: #6c757d; }
        .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; }
        .badge-success { background: #28a745; color: white; }
        .badge-danger { background: #dc3545; color: white; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-icon { font-size: 2rem; color: #420942; margin-bottom: 0.5rem; }
        .stat-number { font-size: 2rem; font-weight: 700; color: #420942; }
        .stat-label { color: #666; font-size: 0.9rem; }
        .deadline-info { background: #f8f9fa; padding: 0.5rem; border-radius: 5px; display: inline-block; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 10px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #ddd; display: flex; justify-content: flex-end; gap: 0.5rem; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 1rem; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f5f5f5; font-weight: 600; }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1001; }
        .toast { background: #333; color: white; padding: 1rem; border-radius: 5px; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; animation: slideIn 0.3s ease; }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        .toast.warning { background: #ffc107; color: #333; }
        .toast.info { background: #17a2b8; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .admin-badge { background: #28a745; color: white; padding: 0.5rem 1rem; border-radius: 20px; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; }
        .mobile-menu-btn { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        @media (max-width: 768px) {
            .mobile-menu-btn { display: block; }
            .nav { display: none; flex-direction: column; position: absolute; top: 100%; left: 0; right: 0; background: white; box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
            .nav.active { display: flex; }
            .nav-link, .admin-badge { padding: 1rem; border-bottom: 1px solid #eee; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
        .card { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn-outline { background: white; border: 1px solid #420942; color: #420942; }
        .btn-outline:hover { background: #420942; color: white; }
        .btn-primary { background: #420942; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; }
        .btn-secondary { background: #6c757d; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; }
        .btn-danger { background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; }
        .btn-accent { background: #ff6b6b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; }
        .btn-warning { background: #ffc107; color: #333; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; }
        .btn:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <a href="index.html" class="logo">
                <img src="assets/nfonap-logo.jpg" alt="NFONAP University" class="logo-img">
                <div>
                    <div class="logo-text">NFONAP UNIVERSITY</div>
                    <div class="logo-tagline">Admin Dashboard</div>
                </div>
            </a>
            
            <nav class="nav">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="miss.html" class="nav-link">
                    <i class="fas fa-female"></i> Miss
                </a>
                <a href="master.html" class="nav-link">
                    <i class="fas fa-male"></i> Master
                </a>
                <a href="admin.html" class="admin-badge" style="background: linear-gradient(135deg, #28a745, #20c997);">
                    <i class="fas fa-user-shield"></i> Admin
                </a>
                <button class="btn btn-danger btn-sm" onclick="logout()" id="logout-btn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </nav>
            
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Admin Dashboard -->
    <section class="hero" style="padding-top: 120px; min-height: 100vh;">
        <div class="container">
            <!-- Login Section -->
            <div id="login-section" class="text-center" style="max-width: 400px; margin: 0 auto; padding: 3rem;">
                <h2 style="margin-bottom: 2rem;">Admin Login</h2>
                <div class="form-group">
                    <input type="text" id="admin-username" class="form-control" placeholder="Username" style="margin-bottom: 1rem;">
                </div>
                <div class="form-group">
                    <input type="password" id="admin-password" class="form-control" placeholder="Password" style="margin-bottom: 1.5rem;">
                </div>
                <button class="btn btn-primary btn-full" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <div class="form-text text-center mt-3">
                    <strong>Default:</strong> admin / nfonap2025<br>
                    <small class="text-danger">Change password after first login!</small>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard-section" style="display: none;">
                <!-- Dashboard Header -->
                <div class="d-flex justify-between align-center mb-4">
                    <div>
                        <h1 style="margin-bottom: 0.5rem;">Admin Dashboard</h1>
                        <p>Welcome, <span id="admin-name">Admin</span> | Last login: <span id="last-login">Now</span></p>
                    </div>
                    <div class="d-flex gap-1">
                        <button class="btn btn-secondary" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-accent" onclick="exportData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-primary" onclick="showAddCandidateModal()">
                            <i class="fas fa-user-plus"></i> Add Candidate
                        </button>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="stats-grid mb-4">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-number" id="admin-total-candidates">0</div>
                        <div class="stat-label">Total Candidates</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-vote-yea"></i>
                        </div>
                        <div class="stat-number" id="admin-total-votes">0</div>
                        <div class="stat-label">Total Votes</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-female"></i>
                        </div>
                        <div class="stat-number" id="admin-miss-candidates">0</div>
                        <div class="stat-label">Miss Candidates</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-male"></i>
                        </div>
                        <div class="stat-number" id="admin-master-candidates">0</div>
                        <div class="stat-label">Master Candidates</div>
                    </div>
                </div>

                <!-- Candidates Management -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div class="d-flex justify-between align-center mb-3">
                        <h3 style="margin: 0;">Manage Candidates</h3>
                        <div class="d-flex gap-1" id="filter-buttons">
                            <button class="btn btn-sm btn-primary" onclick="filterCandidates('all')">All</button>
                            <button class="btn btn-sm btn-outline" onclick="filterCandidates('miss')">Miss</button>
                            <button class="btn btn-sm btn-outline" onclick="filterCandidates('master')">Master</button>
                        </div>
                    </div>
                    
                    <div id="candidates-table">
                        <!-- Candidates will be loaded here -->
                    </div>
                </div>

                <!-- Database Management -->
                <div class="card">
                    <h3 style="margin-bottom: 1.5rem;">Database Management</h3>
                    <div class="d-flex gap-2">
                        <button class="btn btn-secondary" onclick="backupDatabase()">
                            <i class="fas fa-database"></i> Backup Database
                        </button>
                        <button class="btn btn-secondary" onclick="restoreDatabase()">
                            <i class="fas fa-upload"></i> Restore Database
                        </button>
                        <button class="btn btn-danger" onclick="resetDatabase()">
                            <i class="fas fa-trash"></i> Reset Database
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Add Candidate Modal -->
    <div id="add-candidate-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Add New Candidate</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-candidate-form">
                    <div class="d-flex gap-2 mb-3">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Category *</label>
                            <select id="candidate-category" class="form-control" required>
                                <option value="">Select Category</option>
                                <option value="miss">Miss NFONAP</option>
                                <option value="master">Master NFONAP</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">Full Name *</label>
                            <input type="text" id="candidate-name" class="form-control" placeholder="John Doe" required>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 mb-3">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Program *</label>
                            <input type="text" id="candidate-program" class="form-control" placeholder="Computer Science" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Department *</label>
                            <input type="text" id="candidate-department" class="form-control" placeholder="Faculty of Engineering" required>
                        </div>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Email (Optional)</label>
                        <input type="email" id="candidate-email" class="form-control" placeholder="candidate@nfonap.edu.cm">
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Biography *</label>
                        <textarea id="candidate-bio" class="form-control" rows="3" placeholder="Candidate biography..." required></textarea>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Manifesto (Optional)</label>
                        <textarea id="candidate-manifesto" class="form-control" rows="3" placeholder="Candidate manifesto..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-candidate-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="addCandidate()">Add Candidate</button>
            </div>
        </div>
    </div>

    <!-- Edit Candidate Modal -->
    <div id="edit-candidate-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Edit Candidate</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-candidate-form">
                    <input type="hidden" id="edit-candidate-id">
                    
                    <div class="d-flex gap-2 mb-3">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Category *</label>
                            <select id="edit-candidate-category" class="form-control" required>
                                <option value="miss">Miss NFONAP</option>
                                <option value="master">Master NFONAP</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">Full Name *</label>
                            <input type="text" id="edit-candidate-name" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 mb-3">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Program *</label>
                            <input type="text" id="edit-candidate-program" class="form-control" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Department *</label>
                            <input type="text" id="edit-candidate-department" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" id="edit-candidate-email" class="form-control">
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Biography *</label>
                        <textarea id="edit-candidate-bio" class="form-control" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Manifesto</label>
                        <textarea id="edit-candidate-manifesto" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('edit-candidate-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="updateCandidate()">Update Candidate</button>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div id="password-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Change Password</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-3">
                    <label class="form-label">Current Password *</label>
                    <input type="password" id="current-password" class="form-control" required>
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">New Password *</label>
                    <input type="password" id="new-password" class="form-control" required>
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">Confirm Password *</label>
                    <input type="password" id="confirm-password" class="form-control" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('password-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <script>
        // Simple database management
        const STORAGE_KEYS = {
            CANDIDATES: 'nfonap_candidates_v2',
            VOTES: 'nfonap_votes_v2',
            VOTERS: 'nfonap_voters_v2',
            SETTINGS: 'nfonap_settings_v2',
            ADMIN_PASSWORD: 'adminPassword'
        };

        let currentFilter = 'all';
        let adminSession = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminSession();
            initializeEventListeners();
            initializeDefaultData();
        });

        function initializeDefaultData() {
            // Check if candidates exist, if not create default
            const candidates = getCandidates();
            if (candidates.length === 0) {
                const defaultCandidates = [
                    {
                        id: 'candidate-1',
                        category: 'miss',
                        name: 'Amara Ndeze',
                        program: 'Computer Science',
                        department: 'Faculty of Engineering',
                        email: 'amara.ndeze@nfonap.edu.cm',
                        bio: 'Passionate about technology and community development. Active in student organizations.',
                        manifesto: 'Dedicated to improving campus technology infrastructure and fostering innovation.',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'candidate-2',
                        category: 'miss',
                        name: 'Christelle Tanyi',
                        program: 'Business Administration',
                        department: 'Faculty of Business',
                        email: 'christelle.tanyi@nfonap.edu.cm',
                        bio: 'Entrepreneur and business enthusiast with a focus on sustainable development.',
                        manifesto: 'Committed to promoting entrepreneurship and supporting student businesses.',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'candidate-3',
                        category: 'master',
                        name: 'David Ngufor',
                        program: 'Software Engineering',
                        department: 'Faculty of Engineering',
                        email: 'david.ngufor@nfonap.edu.cm',
                        bio: 'Tech leader with experience in software development and project management.',
                        manifesto: 'Working towards digital transformation and excellence in academic excellence.',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'candidate-4',
                        category: 'master',
                        name: 'Benjamin Nkwa',
                        program: 'Finance',
                        department: 'Faculty of Business',
                        email: 'benjamin.nkwa@nfonap.edu.cm',
                        bio: 'Economics scholar focused on development and financial inclusion.',
                        manifesto: 'Advocating for economic growth and student welfare improvement.',
                        createdAt: new Date().toISOString()
                    }
                ];
                
                saveCandidates(defaultCandidates);
            }
            
            // Initialize admin password if not set
            if (!localStorage.getItem(STORAGE_KEYS.ADMIN_PASSWORD)) {
                localStorage.setItem(STORAGE_KEYS.ADMIN_PASSWORD, 'nfonap2025');
            }
            
            // Initialize settings if not set
            if (!localStorage.getItem(STORAGE_KEYS.SETTINGS)) {
                const settings = {
                    electionTitle: 'NFONAP Miss & Master Elections 2025',
                    votingDeadline: '2025-12-13T13:00:00',
                    allowVoting: true
                };
                localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
            }
        }

        function initializeEventListeners() {
            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal-overlay');
                    modal.style.display = 'none';
                });
            });

            // Mobile menu
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', function() {
                    const nav = document.querySelector('.nav');
                    nav.classList.toggle('active');
                });
            }

            // Enter key for login
            document.getElementById('admin-password')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        }

        // Database helper functions
        function getCandidates() {
            const data = localStorage.getItem(STORAGE_KEYS.CANDIDATES);
            return data ? JSON.parse(data) : [];
        }

        function saveCandidates(candidates) {
            localStorage.setItem(STORAGE_KEYS.CANDIDATES, JSON.stringify(candidates));
        }

        function getVotes() {
            const data = localStorage.getItem(STORAGE_KEYS.VOTES);
            return data ? JSON.parse(data) : [];
        }

        function getVoters() {
            const data = localStorage.getItem(STORAGE_KEYS.VOTERS);
            return data ? JSON.parse(data) : [];
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div>${message}</div>
                <button onclick="this.parentElement.remove()" style="background:none; border:none; color:white; cursor:pointer">&times;</button>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // Login functions
        function checkAdminSession() {
            const session = sessionStorage.getItem('adminSession');
            if (session) {
                adminSession = JSON.parse(session);
                showDashboard();
            }
        }

        function login() {
            const username = document.getElementById('admin-username').value.trim();
            const password = document.getElementById('admin-password').value.trim();

            if (!username || !password) {
                showToast('Please enter username and password', 'warning');
                return;
            }

            const storedPassword = localStorage.getItem(STORAGE_KEYS.ADMIN_PASSWORD) || 'nfonap2025';
            
            if (username === 'admin' && password === storedPassword) {
                adminSession = {
                    username: username,
                    loginTime: new Date().toISOString()
                };
                sessionStorage.setItem('adminSession', JSON.stringify(adminSession));
                showDashboard();
                showToast('Login successful!', 'success');
            } else {
                showToast('Invalid username or password', 'error');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('adminSession');
                adminSession = null;
                showLoginForm();
                showToast('Logged out successfully', 'info');
            }
        }

        function showLoginForm() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            document.getElementById('logout-btn').style.display = 'inline-block';
            document.getElementById('admin-name').textContent = adminSession.username;
            document.getElementById('last-login').textContent = new Date(adminSession.loginTime).toLocaleString();
            refreshDashboard();
        }

        // Dashboard functions
        function refreshDashboard() {
            updateStatistics();
            loadCandidatesTable();
        }

        function updateStatistics() {
            const candidates = getCandidates();
            const votes = getVotes();
            
            const totalCandidates = candidates.length;
            const missCandidates = candidates.filter(c => c.category === 'miss').length;
            const masterCandidates = candidates.filter(c => c.category === 'master').length;
            const totalVotes = votes.length;

            document.getElementById('admin-total-candidates').textContent = totalCandidates;
            document.getElementById('admin-total-votes').textContent = totalVotes;
            document.getElementById('admin-miss-candidates').textContent = missCandidates;
            document.getElementById('admin-master-candidates').textContent = masterCandidates;
        }

        function loadCandidatesTable() {
            const container = document.getElementById('candidates-table');
            let candidates = getCandidates();

            // Apply filter
            if (currentFilter === 'miss') {
                candidates = candidates.filter(c => c.category === 'miss');
            } else if (currentFilter === 'master') {
                candidates = candidates.filter(c => c.category === 'master');
            }

            if (candidates.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No candidates found</p>';
                return;
            }

            const votes = getVotes();
            
            let html = '<table class="table">';
            html += '<thead><tr>';
            html += '<th>Name</th>';
            html += '<th>Category</th>';
            html += '<th>Program</th>';
            html += '<th>Votes</th>';
            html += '<th>Actions</th>';
            html += '</tr></thead><tbody>';

            candidates.forEach(candidate => {
                const voteCount = votes.filter(v => v.candidateId === candidate.id).length;
                const categoryLabel = candidate.category === 'miss' ? 'ðŸ‘© Miss' : 'ðŸ‘¨ Master';
                
                html += `<tr>
                    <td>${candidate.name}</td>
                    <td>${categoryLabel}</td>
                    <td>${candidate.program}</td>
                    <td><strong>${voteCount}</strong></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editCandidate('${candidate.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCandidate('${candidate.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Update filter buttons
            updateFilterButtons();
        }

        function updateFilterButtons() {
            const buttons = document.querySelectorAll('#filter-buttons button');
            buttons.forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            });
            
            const activeBtn = Array.from(buttons).find(btn => 
                btn.textContent.toLowerCase().includes(currentFilter)
            );
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline');
                activeBtn.classList.add('btn-primary');
            }
        }

        function filterCandidates(filter) {
            currentFilter = filter;
            loadCandidatesTable();
        }

        // Candidate management
        function showAddCandidateModal() {
            document.getElementById('add-candidate-form').reset();
            document.getElementById('add-candidate-modal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function addCandidate() {
            const category = document.getElementById('candidate-category').value;
            const name = document.getElementById('candidate-name').value.trim();
            const program = document.getElementById('candidate-program').value.trim();
            const department = document.getElementById('candidate-department').value.trim();
            const email = document.getElementById('candidate-email').value.trim();
            const bio = document.getElementById('candidate-bio').value.trim();
            const manifesto = document.getElementById('candidate-manifesto').value.trim();

            if (!category || !name || !program || !department || !bio) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }

            const candidates = getCandidates();
            const candidate = {
                id: 'candidate-' + Date.now(),
                category,
                name,
                program,
                department,
                email,
                bio,
                manifesto,
                createdAt: new Date().toISOString()
            };

            candidates.push(candidate);
            saveCandidates(candidates);
            
            closeModal('add-candidate-modal');
            refreshDashboard();
            showToast('Candidate added successfully!', 'success');
        }

        function editCandidate(candidateId) {
            const candidates = getCandidates();
            const candidate = candidates.find(c => c.id === candidateId);
            
            if (!candidate) {
                showToast('Candidate not found', 'error');
                return;
            }

            document.getElementById('edit-candidate-id').value = candidate.id;
            document.getElementById('edit-candidate-category').value = candidate.category;
            document.getElementById('edit-candidate-name').value = candidate.name;
            document.getElementById('edit-candidate-program').value = candidate.program;
            document.getElementById('edit-candidate-department').value = candidate.department;
            document.getElementById('edit-candidate-email').value = candidate.email || '';
            document.getElementById('edit-candidate-bio').value = candidate.bio;
            document.getElementById('edit-candidate-manifesto').value = candidate.manifesto || '';

            document.getElementById('edit-candidate-modal').style.display = 'flex';
        }

        function updateCandidate() {
            const candidateId = document.getElementById('edit-candidate-id').value;
            const category = document.getElementById('edit-candidate-category').value;
            const name = document.getElementById('edit-candidate-name').value.trim();
            const program = document.getElementById('edit-candidate-program').value.trim();
            const department = document.getElementById('edit-candidate-department').value.trim();
            const email = document.getElementById('edit-candidate-email').value.trim();
            const bio = document.getElementById('edit-candidate-bio').value.trim();
            const manifesto = document.getElementById('edit-candidate-manifesto').value.trim();

            if (!category || !name || !program || !department || !bio) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }

            const candidates = getCandidates();
            const candidateIndex = candidates.findIndex(c => c.id === candidateId);
            
            if (candidateIndex === -1) {
                showToast('Candidate not found', 'error');
                return;
            }

            candidates[candidateIndex] = {
                ...candidates[candidateIndex],
                category,
                name,
                program,
                department,
                email,
                bio,
                manifesto,
                updatedAt: new Date().toISOString()
            };

            saveCandidates(candidates);
            closeModal('edit-candidate-modal');
            refreshDashboard();
            showToast('Candidate updated successfully!', 'success');
        }

        function deleteCandidate(candidateId) {
            if (!confirm('Are you sure you want to delete this candidate? This action cannot be undone.')) {
                return;
            }

            let candidates = getCandidates();
            let votes = getVotes();
            let voters = getVoters();
            
            // Remove candidate
            candidates = candidates.filter(c => c.id !== candidateId);
            
            // Remove votes for this candidate
            votes = votes.filter(v => v.candidateId !== candidateId);
            
            // Remove voters who voted for this candidate
            voters = voters.filter(v => {
                const vote = votes.find(vt => vt.voterEmail === v.email);
                return !vote || vote.candidateId !== candidateId;
            });
            
            saveCandidates(candidates);
            localStorage.setItem(STORAGE_KEYS.VOTES, JSON.stringify(votes));
            localStorage.setItem(STORAGE_KEYS.VOTERS, JSON.stringify(voters));
            
            refreshDashboard();
            showToast('Candidate deleted successfully!', 'success');
        }

        // Database management
        function backupDatabase() {
            const backup = {
                timestamp: new Date().toISOString(),
                candidates: getCandidates(),
                votes: getVotes(),
                voters: getVoters(),
                settings: JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{}')
            };

            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `nfonap-backup-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showToast('Database backed up successfully!', 'success');
        }

        function restoreDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        
                        if (!backup.candidates || !backup.votes || !backup.voters) {
                            throw new Error('Invalid backup file format');
                        }

                        localStorage.setItem(STORAGE_KEYS.CANDIDATES, JSON.stringify(backup.candidates));
                        localStorage.setItem(STORAGE_KEYS.VOTES, JSON.stringify(backup.votes));
                        localStorage.setItem(STORAGE_KEYS.VOTERS, JSON.stringify(backup.voters));
                        if (backup.settings) {
                            localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(backup.settings));
                        }

                        refreshDashboard();
                        showToast('Database restored successfully!', 'success');
                    } catch (error) {
                        showToast('Error restoring database: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetDatabase() {
            const confirmed = confirm('âš ï¸ WARNING! This will permanently delete ALL data (candidates, votes, etc.). This action cannot be undone. Are you sure?');
            
            if (!confirmed) {
                showToast('Reset cancelled', 'info');
                return;
            }

            const finalConfirm = confirm('This is your LAST warning. Type "RESET" in the next prompt to confirm.');
            
            if (!finalConfirm) {
                showToast('Reset cancelled', 'info');
                return;
            }

            const userInput = prompt('Type "RESET" to confirm permanent data deletion:');
            
            if (userInput === 'RESET') {
                localStorage.removeItem(STORAGE_KEYS.CANDIDATES);
                localStorage.removeItem(STORAGE_KEYS.VOTES);
                localStorage.removeItem(STORAGE_KEYS.VOTERS);
                
                // Reset to default data
                initializeDefaultData();
                
                refreshDashboard();
                showToast('Database has been reset!', 'success');
            } else {
                showToast('Reset cancelled', 'info');
            }
        }

        function exportData() {
            const candidates = getCandidates();
            const votes = getVotes();
            
            let csv = 'Name,Category,Program,Department,Email,Votes\n';
            
            candidates.forEach(candidate => {
                const voteCount = votes.filter(v => v.candidateId === candidate.id).length;
                const row = [
                    candidate.name,
                    candidate.category,
                    candidate.program,
                    candidate.department,
                    candidate.email || '',
                    voteCount
                ].map(val => `"${val}"`).join(',');
                csv += row + '\n';
            });

            const dataBlob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `nfonap-export-${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showToast('Data exported successfully!', 'success');
        }

        function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Please fill in all password fields', 'warning');
                return;
            }

            const storedPassword = localStorage.getItem(STORAGE_KEYS.ADMIN_PASSWORD) || 'nfonap2025';
            
            if (currentPassword !== storedPassword) {
                showToast('Current password is incorrect', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showToast('New passwords do not match', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showToast('New password must be at least 6 characters', 'warning');
                return;
            }

            localStorage.setItem(STORAGE_KEYS.ADMIN_PASSWORD, newPassword);
            
            closeModal('password-modal');
            showToast('Password changed successfully!', 'success');
        }

        // Make functions available globally
        window.login = login;
        window.logout = logout;
        window.refreshDashboard = refreshDashboard;
        window.exportData = exportData;
        window.showAddCandidateModal = showAddCandidateModal;
        window.closeModal = closeModal;
        window.addCandidate = addCandidate;
        window.editCandidate = editCandidate;
        window.updateCandidate = updateCandidate;
        window.deleteCandidate = deleteCandidate;
        window.filterCandidates = filterCandidates;
        window.backupDatabase = backupDatabase;
        window.restoreDatabase = restoreDatabase;
        window.resetDatabase = resetDatabase;
        window.changePassword = changePassword;
    </script>
</body>
</html>
